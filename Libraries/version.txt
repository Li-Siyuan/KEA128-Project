
//2018.1.18
1、新增按键在直立、速度、转向模式转换
2、新增电磁检测归一化，（未确定最终归一化后的范围是否合适）。并改变速度环一些细节，待调试

现阶段任务：
1、搭出新结构（这次注意6050安放正确）
2、赛道检测最终处理结果打印出来，保证赛道检测正确性
3、重调直立环与速度环，保证大于等于之前速度环的稳定性，缩短控制周期
4、更改转向环算法






//****************下面为以前版本****************************************************************************************************************************//
V1.0
搭出大体框架

		
V2.0
加入山外新虚拟示波器的协议，传输int型波形
修复抗积分饱和部分bug
参数直接写入flash，最后一个扇区，便于保存调试数据
直立环加入了滑动PD和专家PD。但专家PID参数有点多了，并且难调，难以发挥极致，导致可能效果还没普通的好，考虑目前先用滑动PD调着，后期提速阶段再试试专家PID或者模糊
新增五电感赛道检测算法，与一般形式PD转向环
		

		
V3.0
新增模糊PD
速度调节要平滑，加入一阶滞后滤波
修复增加速度环控制时间的bug，把每次控制输出平均分成20份到每次直立输出里
新增变速积分
赛道检测方法更改



V4.0
绿波完成，并纠正角度滤波之前过程中变量的类型
增加时钟源为外部时钟及内部时钟源两种时钟源，超频到80MHz
模拟iic延时缩短

待改进：        修改工程配置以使用printf
                修改mpu6050里函数返回值类型，以修复无负值bug
                后续数据类型、正负号调试后纠正
		脉冲值归一化到PWM（转换成线性）
		新增DEBUG_MODE模式，用于第一次校赛赛道，没有出圆环判断
                
                
V4.1
mpu6050改用逐飞程序


V5.1
更改电机编码器方向
修复取大取小bug
更改检测adc值算法


V6.0
更改电机编码器方向
增加lcd+key+flash下位机调试程序
直立


V8.1
对编码风格进行整理改进:将直立环、速度环、转向环、按键文件分开，添加oled表示位数变化的有符号变量（-9999~9999）。由于分开后数量不多，并未对全局变量进行改进，不影响使用。
修改积分下限为500，积分速度增加5倍，可以通过按键修改积分速度





对于速度环卓晴方案的理解：速度环本质是对期望角度的控制，通过输出加速度形成角度，但由于微分噪音的影响，卓晴方案把对期望角度的控制转换成了直接对PWM的控制
						
						速度环实际上是在检测当前速度与给定速度做差得到速度偏差（负反馈思想），然后归一化到角度上，通过PID控制器的比例项与微分项得到期望角度传给直立环，相当于与直立环构成了串级PID。
						但由于车轮的速度反馈信号中往往存在着噪声，对速度进行微分运算会进一步加大噪声的影响，且分析可知由微分控制的期望角度经过直立控制相当于增加了一个积分，所以可以把微分项与该积分效果相结合，把期望角度控制的微分项转换为绕过直立环直接对PWM进行控制的比例项。从而既加入了微分效果，又避免噪音影响（传递函数不变）
						而由于目前速度控制没有积分项，而在期望角度控制上增加积分项会增加系统复杂程度，故通过把期望角度控制上的比例项转换为PWM控制上的积分项得以解决。
						
直立环与速度环控制效果：	只有直立环时，理想状态下车模能定在零位，但由于传感器漂移及安装导致的机械零位与程序零位不重合的原因，可能受重力效果会向倾斜方向加速前进。
						加入速度环后，若没有积分项，理想状态下是严格控制到期望角度为0度，即静止在原地，但由于期望角度存在静态偏差，导致车模会往倾斜方向匀速行驶，只有加入积分效果才会严格控制期望角度为0，静止在原地。